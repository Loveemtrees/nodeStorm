<!doctype html>
<html>
  <head>
    <title>Socket.io Test - HOST</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>
  <body>
    <!--TEXT_BOX------------------------------------>
    <script>    
      var socket = io();
      var replies = [];

      socket.on('date', function(data){
        $('#date').text(data.date);
      });

      $(document).ready(function(){

          // MESSAGE TO CLIENTS------------------------------------>
          $("form").submit(function () {
              socket.emit("host_message", $("#m").val());
              $("#replies > li").remove();
              $("#messages > .list-group-item").removeClass("active");
              $("#messages").prepend($("<li>").addClass("list-group-item active").text($("#m").val()));
              $("#replyCounter").text("Noch niemand hat geantwortet");
              replies = [];
              $("#m").val("");
              return false;
          });
          socket.on("client_message", function (msg) {
              if($("#messages .list-group-item:first-of-type").is(".active")) {
                  $("#replies").prepend($("<li>").addClass("list-group-item").text(msg));
              }
              replies ++;
              $("#messages .list-group-item:first-of-type span").remove();
              $("#messages .list-group-item:first-of-type").append($("<span>").addClass("badge").text(replies));
          });
          socket.on("counter_update", function (msg) {
              $("#connected_count").text(msg);
          });
          // receive the requested replies and implement into DOM-tree
          socket.on("requested_replies", function (msg) {
              console.log(msg);
              $("#replies li").remove();
              for (var i = 0; i < msg.length; i++){
                  var reply = msg[i];
                  $("#replies").prepend($("<li>").fadeIn("slow").addClass("list-group-item").text(reply));
              }
          });
          socket.on("replyCounter", function (msg) {
              $("#replyCounter").text(msg+ " Personen haben geantwortet");
          });
          // --------------------------------------------------------

          // click on a message list element will send a request for related replies to server
          $("#messages").on("click", ".list-group-item", function(){
              if( !$(this).is(":first-of-type") ){
                  $("#messages > .list-group-item").removeClass("active");
                  $(this).addClass("active");
                  var textWithoutNumber = $(this).text().replace(/[0-9]/g, '');
                  socket.emit("get_replies", textWithoutNumber);
              }
          });
          $("#messages").on("click", ".list-group-item:first-child", function(){
              $("#messages > .list-group-item").removeClass("active");
              $(this).addClass("active");
              // Clean text from number of badge
              var textWithoutNumber = $(this).text().replace(/[0-9]/g, '');
              socket.emit("get_replies_for_actual", textWithoutNumber );
          });


    });
    </script>

    <div class="container">
        <div class="header">
            <ul class="nav nav-pills pull-right">
                <li class="text-muted"><h3>HOST</h3></li>
            </ul>
            <h3 class="text-muted">Audience Response Brainstorming <small>v0.1.1</small></h3>
        </div>
        <div class="meta"><span id="date"></span><span id="connected"><span class="badge" id="connected_count">0</span> connected</span></div>
        <div class="jumbotron">
            <p class="lead">Stellen Sie eine Frage an die Studenten!</p>
            <form class="form-inline" role="form" action="">
                <input id="m" type="text" class="form-control" placeholder="Was faellt Ihnen ein zu ...">
                <button class="btn btn-success">Send</button>
            </form>
            <p id="replyCounter"></p>
        </div>

        <div class="row marketing">
            <div class="col-lg-6">
                <span class="list-head">Gestellte Fragen</span>
                <!-- Liste der vergangenen Fragen -->
                <ul id="messages" class="list-group no-scroll-limit"></ul>
            </div>

            <div class="col-lg-6">
                <span class="list-head">Erhaltene Antworten</span>
                <!-- Liste der Antworten -->
                <ul id="replies" class="list-group no-scroll-limit"></ul>
            </div>
        </div>

        <div class="footer">
            <p>&copy; Sebastian Baumgarten 2014</p>
        </div>

    </div> <!-- /container -->
  </body>
</html>